<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Create</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Create</h1>



<p>Each ecocomDP dataset (Level-1; L1) is created from a source dataset (Level-0; L0) by a unique processing function. Inputs are typically from the APIs of data repositories and monitoring networks, and outputs can be a list of R objects or a set of archivable files. The output form you choose may depend on multiple factors including the source data license (it may prohibit archive) and the overall processing time (on-demand processing may be prohibitively long). In either case, the derived ecocomDP dataset is delivered to users in a consistent format by <code>read_data()</code> and the processing function provides a fully reproducible and automated routine for updating the derived dataset whenever a new version of the source data are released.</p>
<p>Below is an example function that reads a source dataset from the Environmental Data Initiative (EDI) repository and converts it into an ecocomDP dataset, which in turn is archived in EDI. For an example of creating an ecocomDP dataset on-demand (i.e.Â not archived), see the map_neon_data_to_ecocomDP.R source code.</p>
<p>Use <code>view_diagram()</code> and <code>view_descriptions()</code> for an overview of ecocomDP table relationships and requirements.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(ecocomDP)</span></code></pre></div>
<div id="for-archive-in-a-data-repository" class="section level2">
<h2>For archive in a data repository</h2>
<div id="example-function" class="section level4">
<h4>Example function:</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># This function converts source dataset &quot;knb-lter-hfr.118&quot; (archived in the EDI</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># Data Repository) to ecocomDP dataset &quot;edi.193&quot; (also archived in EDI)</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"># </span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co"># Arguments:</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">#</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># path        Where the ecocomDP tables will be written</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># source_id   Identifier of the source dataset</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co"># derived_id  Identifier of the derived dataset</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co"># url         The URL by which the derived tables and metadata can be accessed </span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">#             by a data repository. This argument is used when automating the </span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">#             repository publication step, but not used when manually </span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">#             publishing.</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">#</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co"># Value:</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co">#</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co"># tables      (.csv) ecocomDP tables</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co"># metadata    (.xml) EML metadata for tables</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co"># </span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co"># Details:</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co">#             This function facilitates automated updates to the derived </span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co">#             &quot;edi.193&quot; whenever new data are added to the source </span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">#             &quot;knb-lter-hrf.118&quot;. The framework executing this maintenance </span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co">#             routine is hosted on a remote server and jumps into action </span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">#             whenever an update notification is received for </span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="co">#             &quot;knb-lter-hrf.118&quot;. The maintenance routine parses the </span></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">#             notification to get the arguments to create_ecocomDP().</span></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="co">#</span></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co"># Landing page to source dataset &quot;knb-lter-hfr.118&quot;:</span></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="co"># https://portal.edirepository.org/nis/mapbrowse?scope=knb-lter-hfr&amp;identifier=118</span></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co"># Landing page to derived dataset &quot;edi.193&quot;:</span></span>
<span id="cb2-32"><a href="#cb2-32"></a><span class="co"># https://portal.edirepository.org/nis/mapbrowse?scope=edi&amp;identifier=193</span></span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb2-34"><a href="#cb2-34"></a></span>
<span id="cb2-35"><a href="#cb2-35"></a><span class="co"># Libraries used by this function</span></span>
<span id="cb2-36"><a href="#cb2-36"></a></span>
<span id="cb2-37"><a href="#cb2-37"></a><span class="kw">library</span>(ecocomDP)</span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="kw">library</span>(xml2)</span>
<span id="cb2-39"><a href="#cb2-39"></a><span class="kw">library</span>(magrittr)</span>
<span id="cb2-40"><a href="#cb2-40"></a><span class="kw">library</span>(data.table)</span>
<span id="cb2-41"><a href="#cb2-41"></a><span class="kw">library</span>(lubridate)</span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb2-43"><a href="#cb2-43"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb2-44"><a href="#cb2-44"></a><span class="kw">library</span>(EDIutils)       <span class="co"># remotes::install_github(&quot;EDIorg/EDIutils&quot;)</span></span>
<span id="cb2-45"><a href="#cb2-45"></a><span class="kw">library</span>(taxonomyCleanr) <span class="co"># remotes::install_github(&quot;EDIorg/taxonomyCleanr&quot;)</span></span>
<span id="cb2-46"><a href="#cb2-46"></a></span>
<span id="cb2-47"><a href="#cb2-47"></a>create_ecocomDP &lt;-<span class="st"> </span><span class="cf">function</span>(path,</span>
<span id="cb2-48"><a href="#cb2-48"></a>                            source_id, </span>
<span id="cb2-49"><a href="#cb2-49"></a>                            derived_id, </span>
<span id="cb2-50"><a href="#cb2-50"></a>                            <span class="dt">url =</span> <span class="ot">NULL</span>) {</span>
<span id="cb2-51"><a href="#cb2-51"></a>  </span>
<span id="cb2-52"><a href="#cb2-52"></a>  <span class="co"># Read source dataset -------------------------------------------------------</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>  <span class="co"># The source dataset is about ant communities and their functional traits </span></span>
<span id="cb2-54"><a href="#cb2-54"></a>  <span class="co"># changing in response to an invasive species. Observations are made across </span></span>
<span id="cb2-55"><a href="#cb2-55"></a>  <span class="co"># habitat types within the Harvard Experimental Forest. The dataset consists </span></span>
<span id="cb2-56"><a href="#cb2-56"></a>  <span class="co"># of a primary table listing abundances at sites through time, and an </span></span>
<span id="cb2-57"><a href="#cb2-57"></a>  <span class="co"># ancillary table listing physical and functional traits of observed species.</span></span>
<span id="cb2-58"><a href="#cb2-58"></a>  </span>
<span id="cb2-59"><a href="#cb2-59"></a>  <span class="co"># Read the source dataset from EDI</span></span>
<span id="cb2-60"><a href="#cb2-60"></a>  </span>
<span id="cb2-61"><a href="#cb2-61"></a>  eml &lt;-<span class="st"> </span>EDIutils<span class="op">::</span><span class="kw">api_read_metadata</span>(source_id)</span>
<span id="cb2-62"><a href="#cb2-62"></a>  data &lt;-<span class="st"> </span>EDIutils<span class="op">::</span><span class="kw">read_tables</span>(</span>
<span id="cb2-63"><a href="#cb2-63"></a>    <span class="dt">eml =</span> eml, </span>
<span id="cb2-64"><a href="#cb2-64"></a>    <span class="dt">strip.white =</span> <span class="ot">TRUE</span>,</span>
<span id="cb2-65"><a href="#cb2-65"></a>    <span class="dt">na.strings =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb2-66"><a href="#cb2-66"></a>    <span class="dt">convert.missing.value =</span> <span class="ot">TRUE</span>, </span>
<span id="cb2-67"><a href="#cb2-67"></a>    <span class="dt">add.units =</span> <span class="ot">TRUE</span>)</span>
<span id="cb2-68"><a href="#cb2-68"></a>  </span>
<span id="cb2-69"><a href="#cb2-69"></a>  ants &lt;-<span class="st"> </span>data<span class="op">$</span><span class="st">`</span><span class="dt">hf118-01-ants.csv</span><span class="st">`</span></span>
<span id="cb2-70"><a href="#cb2-70"></a>  traits &lt;-<span class="st"> </span>data<span class="op">$</span><span class="st">`</span><span class="dt">hf118-02-functional-traits.csv</span><span class="st">`</span></span>
<span id="cb2-71"><a href="#cb2-71"></a>  </span>
<span id="cb2-72"><a href="#cb2-72"></a>  ants<span class="op">$</span>date &lt;-<span class="st"> </span>lubridate<span class="op">::</span><span class="kw">ymd</span>(ants<span class="op">$</span>date)</span>
<span id="cb2-73"><a href="#cb2-73"></a></span>
<span id="cb2-74"><a href="#cb2-74"></a>  <span class="co"># Join and flatten the source dataset ---------------------------------------</span></span>
<span id="cb2-75"><a href="#cb2-75"></a>  <span class="co"># Joining all source data and relevant metadata into one big flat table </span></span>
<span id="cb2-76"><a href="#cb2-76"></a>  <span class="co"># simplifies parsing into ecocomDP tables and facilitates referential </span></span>
<span id="cb2-77"><a href="#cb2-77"></a>  <span class="co"># integrity in the process.</span></span>
<span id="cb2-78"><a href="#cb2-78"></a>  </span>
<span id="cb2-79"><a href="#cb2-79"></a>  <span class="co"># Remove duplicate data from the ancillary table and join on species &quot;code&quot;</span></span>
<span id="cb2-80"><a href="#cb2-80"></a>  </span>
<span id="cb2-81"><a href="#cb2-81"></a>  traits &lt;-<span class="st"> </span>traits <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>genus, <span class="op">-</span>species)</span>
<span id="cb2-82"><a href="#cb2-82"></a>  traits &lt;-<span class="st"> </span>traits <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">code =</span> species.code)</span>
<span id="cb2-83"><a href="#cb2-83"></a>  wide &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(ants, traits, <span class="dt">by =</span> <span class="st">&quot;code&quot;</span>)</span>
<span id="cb2-84"><a href="#cb2-84"></a>  </span>
<span id="cb2-85"><a href="#cb2-85"></a>  <span class="co"># Convert wide format to &quot;flat&quot; format. This is the wide form but gathered on </span></span>
<span id="cb2-86"><a href="#cb2-86"></a>  <span class="co"># core observation variables, which are often &gt; 1 in source datasets. This </span></span>
<span id="cb2-87"><a href="#cb2-87"></a>  <span class="co"># &quot;flat&quot; table is the &quot;widest&quot; ecocomDP datasets can be consistently returned </span></span>
<span id="cb2-88"><a href="#cb2-88"></a>  <span class="co"># to by the ecocomDP::flatten_data() function, and is the input format </span></span>
<span id="cb2-89"><a href="#cb2-89"></a>  <span class="co"># required by the &quot;create table&quot; helpers we&#39;ll meet shortly. This dataset </span></span>
<span id="cb2-90"><a href="#cb2-90"></a>  <span class="co"># only has one core observation variable, &quot;abundance&quot;, so gathering really </span></span>
<span id="cb2-91"><a href="#cb2-91"></a>  <span class="co"># only entials a change of column names. </span></span>
<span id="cb2-92"><a href="#cb2-92"></a>  </span>
<span id="cb2-93"><a href="#cb2-93"></a>  wide &lt;-<span class="st"> </span>wide <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">value_abundance =</span> abundance)</span>
<span id="cb2-94"><a href="#cb2-94"></a>  flat &lt;-<span class="st"> </span>tidyr<span class="op">::</span><span class="kw">pivot_longer</span>(</span>
<span id="cb2-95"><a href="#cb2-95"></a>    wide,</span>
<span id="cb2-96"><a href="#cb2-96"></a>    <span class="dt">cols =</span> <span class="kw">matches</span>(<span class="st">&quot;abundance&quot;</span>), </span>
<span id="cb2-97"><a href="#cb2-97"></a>    <span class="dt">names_to =</span> <span class="kw">c</span>(<span class="st">&quot;.value&quot;</span>, <span class="st">&quot;variable_name&quot;</span>), </span>
<span id="cb2-98"><a href="#cb2-98"></a>    <span class="dt">names_sep =</span> <span class="st">&#39;</span><span class="ch">\\</span><span class="st">_&#39;</span>)</span>
<span id="cb2-99"><a href="#cb2-99"></a>  </span>
<span id="cb2-100"><a href="#cb2-100"></a>  <span class="co"># TIP: Sorting and arranging rows by sample date and location will result in </span></span>
<span id="cb2-101"><a href="#cb2-101"></a>  <span class="co"># a nice chronological dataset for human browsing, which is merely cosmetic </span></span>
<span id="cb2-102"><a href="#cb2-102"></a>  <span class="co"># and completely optional.</span></span>
<span id="cb2-103"><a href="#cb2-103"></a>  </span>
<span id="cb2-104"><a href="#cb2-104"></a>  flat &lt;-<span class="st"> </span>flat <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(date, plot, block)</span>
<span id="cb2-105"><a href="#cb2-105"></a>  </span>
<span id="cb2-106"><a href="#cb2-106"></a>  <span class="co"># We&#39;re now in a good place to begin adding columns of the ecocomDP tables </span></span>
<span id="cb2-107"><a href="#cb2-107"></a>  <span class="co"># we can create from this source dataset. We&#39;ll begin with the observation </span></span>
<span id="cb2-108"><a href="#cb2-108"></a>  <span class="co"># table.</span></span>
<span id="cb2-109"><a href="#cb2-109"></a>  </span>
<span id="cb2-110"><a href="#cb2-110"></a>  <span class="co"># Add columns for the observation table -------------------------------------</span></span>
<span id="cb2-111"><a href="#cb2-111"></a>  </span>
<span id="cb2-112"><a href="#cb2-112"></a>  <span class="co"># Each row of the flattened source dataset represents an observation of taxa </span></span>
<span id="cb2-113"><a href="#cb2-113"></a>  <span class="co"># abundance and should have a unique ID for reference</span></span>
<span id="cb2-114"><a href="#cb2-114"></a>  </span>
<span id="cb2-115"><a href="#cb2-115"></a>  flat<span class="op">$</span>observation_id &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">nrow</span>(flat))</span>
<span id="cb2-116"><a href="#cb2-116"></a>  </span>
<span id="cb2-117"><a href="#cb2-117"></a>  <span class="co"># Observations are made in plots, which are nested in blocks. Unique </span></span>
<span id="cb2-118"><a href="#cb2-118"></a>  <span class="co"># combinations of these form a location</span></span>
<span id="cb2-119"><a href="#cb2-119"></a>  </span>
<span id="cb2-120"><a href="#cb2-120"></a>  flat<span class="op">$</span>location_id &lt;-<span class="st"> </span>flat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(plot, block) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_indices</span>()</span>
<span id="cb2-121"><a href="#cb2-121"></a>  </span>
<span id="cb2-122"><a href="#cb2-122"></a>  <span class="co"># Each combination of location and date form a sampling event</span></span>
<span id="cb2-123"><a href="#cb2-123"></a>  </span>
<span id="cb2-124"><a href="#cb2-124"></a>  flat<span class="op">$</span>event_id &lt;-<span class="st"> </span>flat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(date, plot, block) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_indices</span>()</span>
<span id="cb2-125"><a href="#cb2-125"></a>  </span>
<span id="cb2-126"><a href="#cb2-126"></a>  <span class="co"># Because a location&#39;s context (i.e. plot and block) will be lost when these </span></span>
<span id="cb2-127"><a href="#cb2-127"></a>  <span class="co"># columns are  converted into the location table, we should combine the </span></span>
<span id="cb2-128"><a href="#cb2-128"></a>  <span class="co"># context and values into a single value to preserve meaning.</span></span>
<span id="cb2-129"><a href="#cb2-129"></a>  </span>
<span id="cb2-130"><a href="#cb2-130"></a>  flat<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;plot_&quot;</span>, flat<span class="op">$</span>plot)</span>
<span id="cb2-131"><a href="#cb2-131"></a>  flat<span class="op">$</span>block &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;block_&quot;</span>, flat<span class="op">$</span>block)</span>
<span id="cb2-132"><a href="#cb2-132"></a>  </span>
<span id="cb2-133"><a href="#cb2-133"></a>  <span class="co"># Add columns for the location table ----------------------------------------</span></span>
<span id="cb2-134"><a href="#cb2-134"></a>  </span>
<span id="cb2-135"><a href="#cb2-135"></a>  <span class="co"># Ideally, the source dataset would include latitude, longitude, and </span></span>
<span id="cb2-136"><a href="#cb2-136"></a>  <span class="co"># elevation for each location_id, but all we have are coordinates for the </span></span>
<span id="cb2-137"><a href="#cb2-137"></a>  <span class="co"># area encompassing all sampling locations. The best we can do here is use </span></span>
<span id="cb2-138"><a href="#cb2-138"></a>  <span class="co"># the middle of the bounding box and mean of the bounding elevations.</span></span>
<span id="cb2-139"><a href="#cb2-139"></a>  </span>
<span id="cb2-140"><a href="#cb2-140"></a>  geocov &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">xml_find_all</span>(eml, <span class="st">&quot;.//geographicCoverage&quot;</span>)</span>
<span id="cb2-141"><a href="#cb2-141"></a>  north &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">xml_double</span>(</span>
<span id="cb2-142"><a href="#cb2-142"></a>    xml2<span class="op">::</span><span class="kw">xml_find_all</span>(geocov, <span class="st">&#39;.//northBoundingCoordinate&#39;</span>))</span>
<span id="cb2-143"><a href="#cb2-143"></a>  east &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">xml_double</span>(</span>
<span id="cb2-144"><a href="#cb2-144"></a>    xml2<span class="op">::</span><span class="kw">xml_find_all</span>(geocov, <span class="st">&#39;.//eastBoundingCoordinate&#39;</span>))</span>
<span id="cb2-145"><a href="#cb2-145"></a>  south &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">xml_double</span>(</span>
<span id="cb2-146"><a href="#cb2-146"></a>    xml2<span class="op">::</span><span class="kw">xml_find_all</span>(geocov, <span class="st">&#39;.//southBoundingCoordinate&#39;</span>))</span>
<span id="cb2-147"><a href="#cb2-147"></a>  west &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">xml_double</span>(</span>
<span id="cb2-148"><a href="#cb2-148"></a>    xml2<span class="op">::</span><span class="kw">xml_find_all</span>(geocov, <span class="st">&#39;.//westBoundingCoordinate&#39;</span>))</span>
<span id="cb2-149"><a href="#cb2-149"></a>  elev_max &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">xml_double</span>(</span>
<span id="cb2-150"><a href="#cb2-150"></a>    xml2<span class="op">::</span><span class="kw">xml_find_all</span>(geocov, <span class="st">&#39;.//altitudeMaximum&#39;</span>))</span>
<span id="cb2-151"><a href="#cb2-151"></a>  elev_min &lt;-<span class="st"> </span>xml2<span class="op">::</span><span class="kw">xml_double</span>(</span>
<span id="cb2-152"><a href="#cb2-152"></a>    xml2<span class="op">::</span><span class="kw">xml_find_all</span>(geocov, <span class="st">&#39;.//altitudeMinimum&#39;</span>))</span>
<span id="cb2-153"><a href="#cb2-153"></a>  </span>
<span id="cb2-154"><a href="#cb2-154"></a>  flat<span class="op">$</span>latitude &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">c</span>(north, south))</span>
<span id="cb2-155"><a href="#cb2-155"></a>  flat<span class="op">$</span>longitude &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">c</span>(east, west))</span>
<span id="cb2-156"><a href="#cb2-156"></a>  flat<span class="op">$</span>elevation &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">c</span>(elev_max, elev_min))</span>
<span id="cb2-157"><a href="#cb2-157"></a>  </span>
<span id="cb2-158"><a href="#cb2-158"></a>  <span class="co"># Add columns for the taxon table -------------------------------------------</span></span>
<span id="cb2-159"><a href="#cb2-159"></a>  </span>
<span id="cb2-160"><a href="#cb2-160"></a>  <span class="co"># Taxonomic entities of this dataset are comprised of unique genus and </span></span>
<span id="cb2-161"><a href="#cb2-161"></a>  <span class="co"># species pairs</span></span>
<span id="cb2-162"><a href="#cb2-162"></a>  </span>
<span id="cb2-163"><a href="#cb2-163"></a>  flat &lt;-<span class="st"> </span>flat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-164"><a href="#cb2-164"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">taxon_name =</span> <span class="kw">trimws</span>(<span class="kw">paste</span>(genus, species))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-165"><a href="#cb2-165"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>genus, <span class="op">-</span>species)</span>
<span id="cb2-166"><a href="#cb2-166"></a>  </span>
<span id="cb2-167"><a href="#cb2-167"></a>  flat<span class="op">$</span>taxon_id &lt;-<span class="st"> </span>flat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(taxon_name) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_indices</span>()</span>
<span id="cb2-168"><a href="#cb2-168"></a>  </span>
<span id="cb2-169"><a href="#cb2-169"></a>  <span class="co"># While not required, resolving taxonomic entities to an authority system </span></span>
<span id="cb2-170"><a href="#cb2-170"></a>  <span class="co"># improves the discoverability and interoperability of the ecocomDP dataset. </span></span>
<span id="cb2-171"><a href="#cb2-171"></a>  <span class="co"># We can resolve taxa by sending names through taxonomyCleanr for direct </span></span>
<span id="cb2-172"><a href="#cb2-172"></a>  <span class="co"># matches against the Integrated Taxonomic Information System </span></span>
<span id="cb2-173"><a href="#cb2-173"></a>  <span class="co"># (ITIS; https://www.itis.gov/).</span></span>
<span id="cb2-174"><a href="#cb2-174"></a>  </span>
<span id="cb2-175"><a href="#cb2-175"></a>  taxa_resolved &lt;-<span class="st"> </span>taxonomyCleanr<span class="op">::</span><span class="kw">resolve_sci_taxa</span>(</span>
<span id="cb2-176"><a href="#cb2-176"></a>    <span class="dt">x =</span> <span class="kw">unique</span>(flat<span class="op">$</span>taxon_name),</span>
<span id="cb2-177"><a href="#cb2-177"></a>    <span class="dt">data.sources =</span> <span class="dv">3</span>)</span>
<span id="cb2-178"><a href="#cb2-178"></a></span>
<span id="cb2-179"><a href="#cb2-179"></a>  taxa_resolved &lt;-<span class="st"> </span>taxa_resolved <span class="op">%&gt;%</span></span>
<span id="cb2-180"><a href="#cb2-180"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">select</span>(taxa, rank, authority, authority_id) <span class="op">%&gt;%</span></span>
<span id="cb2-181"><a href="#cb2-181"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">rename</span>(</span>
<span id="cb2-182"><a href="#cb2-182"></a>      <span class="dt">taxon_rank =</span> rank,</span>
<span id="cb2-183"><a href="#cb2-183"></a>      <span class="dt">taxon_name =</span> taxa,</span>
<span id="cb2-184"><a href="#cb2-184"></a>      <span class="dt">authority_system =</span> authority,</span>
<span id="cb2-185"><a href="#cb2-185"></a>      <span class="dt">authority_taxon_id =</span> authority_id)</span>
<span id="cb2-186"><a href="#cb2-186"></a></span>
<span id="cb2-187"><a href="#cb2-187"></a>  flat &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(flat, taxa_resolved, <span class="dt">by =</span> <span class="st">&quot;taxon_name&quot;</span>)</span>
<span id="cb2-188"><a href="#cb2-188"></a>  </span>
<span id="cb2-189"><a href="#cb2-189"></a>  <span class="co"># Add columns for the dataset_summary table ---------------------------------</span></span>
<span id="cb2-190"><a href="#cb2-190"></a>  </span>
<span id="cb2-191"><a href="#cb2-191"></a>  dates &lt;-<span class="st"> </span>flat<span class="op">$</span>date <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">na.omit</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sort</span>()</span>
<span id="cb2-192"><a href="#cb2-192"></a>  </span>
<span id="cb2-193"><a href="#cb2-193"></a>  <span class="co"># Use the calc_*() helper functions for consistency</span></span>
<span id="cb2-194"><a href="#cb2-194"></a>  </span>
<span id="cb2-195"><a href="#cb2-195"></a>  flat<span class="op">$</span>package_id &lt;-<span class="st"> </span>derived_id</span>
<span id="cb2-196"><a href="#cb2-196"></a>  flat<span class="op">$</span>original_package_id &lt;-<span class="st"> </span>source_id</span>
<span id="cb2-197"><a href="#cb2-197"></a>  flat<span class="op">$</span>length_of_survey_years &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">calc_length_of_survey_years</span>(dates)</span>
<span id="cb2-198"><a href="#cb2-198"></a>  flat<span class="op">$</span>number_of_years_sampled &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">calc_number_of_years_sampled</span>(dates)</span>
<span id="cb2-199"><a href="#cb2-199"></a>  flat<span class="op">$</span>std_dev_interval_betw_years &lt;-<span class="st"> </span></span>
<span id="cb2-200"><a href="#cb2-200"></a><span class="st">    </span>ecocomDP<span class="op">::</span><span class="kw">calc_std_dev_interval_betw_years</span>(dates)</span>
<span id="cb2-201"><a href="#cb2-201"></a>  flat<span class="op">$</span>max_num_taxa &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(flat<span class="op">$</span>taxon_name))</span>
<span id="cb2-202"><a href="#cb2-202"></a>  flat<span class="op">$</span>geo_extent_bounding_box_m2 &lt;-<span class="st"> </span></span>
<span id="cb2-203"><a href="#cb2-203"></a><span class="st">    </span>ecocomDP<span class="op">::</span><span class="kw">calc_geo_extent_bounding_box_m2</span>(west, east, north, south)</span>
<span id="cb2-204"><a href="#cb2-204"></a>  </span>
<span id="cb2-205"><a href="#cb2-205"></a>  <span class="co"># Odds and ends -------------------------------------------------------------</span></span>
<span id="cb2-206"><a href="#cb2-206"></a>  </span>
<span id="cb2-207"><a href="#cb2-207"></a>  <span class="co"># Rename source columns with an ecocomDP equivalent (date to datetime) and </span></span>
<span id="cb2-208"><a href="#cb2-208"></a>  <span class="co"># remove columns of redundant information  (year can be recalculated from </span></span>
<span id="cb2-209"><a href="#cb2-209"></a>  <span class="co"># datetime and code was a key that no longer has use).</span></span>
<span id="cb2-210"><a href="#cb2-210"></a>  </span>
<span id="cb2-211"><a href="#cb2-211"></a>  flat &lt;-<span class="st"> </span>flat <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-212"><a href="#cb2-212"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">datetime =</span> date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-213"><a href="#cb2-213"></a><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>year, <span class="op">-</span>code)</span>
<span id="cb2-214"><a href="#cb2-214"></a>  </span>
<span id="cb2-215"><a href="#cb2-215"></a>  <span class="co"># Some columns are not required, but we&#39;ll include them for the sake of </span></span>
<span id="cb2-216"><a href="#cb2-216"></a>  <span class="co"># completenesss</span></span>
<span id="cb2-217"><a href="#cb2-217"></a>  </span>
<span id="cb2-218"><a href="#cb2-218"></a>  flat<span class="op">$</span>author &lt;-<span class="st"> </span><span class="ot">NA_character_</span></span>
<span id="cb2-219"><a href="#cb2-219"></a>  </span>
<span id="cb2-220"><a href="#cb2-220"></a>  <span class="co"># The hard work is done! The flat table contains all the source data and </span></span>
<span id="cb2-221"><a href="#cb2-221"></a>  <span class="co"># more! We can now use the &quot;create&quot; functions to parse this table into the </span></span>
<span id="cb2-222"><a href="#cb2-222"></a>  <span class="co"># ecocomDP tables.</span></span>
<span id="cb2-223"><a href="#cb2-223"></a>  </span>
<span id="cb2-224"><a href="#cb2-224"></a>  <span class="co"># Parse flat into ecocomDP tables -------------------------------------------</span></span>
<span id="cb2-225"><a href="#cb2-225"></a>  </span>
<span id="cb2-226"><a href="#cb2-226"></a>  <span class="co"># Each ecocomDP table has an associated &quot;create&quot; function. Begin with the </span></span>
<span id="cb2-227"><a href="#cb2-227"></a>  <span class="co"># core required tables.</span></span>
<span id="cb2-228"><a href="#cb2-228"></a>  </span>
<span id="cb2-229"><a href="#cb2-229"></a>  observation &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_observation</span>(</span>
<span id="cb2-230"><a href="#cb2-230"></a>    <span class="dt">L0_flat =</span> flat, </span>
<span id="cb2-231"><a href="#cb2-231"></a>    <span class="dt">observation_id =</span> <span class="st">&quot;observation_id&quot;</span>, </span>
<span id="cb2-232"><a href="#cb2-232"></a>    <span class="dt">event_id =</span> <span class="st">&quot;event_id&quot;</span>, </span>
<span id="cb2-233"><a href="#cb2-233"></a>    <span class="dt">package_id =</span> <span class="st">&quot;package_id&quot;</span>,</span>
<span id="cb2-234"><a href="#cb2-234"></a>    <span class="dt">location_id =</span> <span class="st">&quot;location_id&quot;</span>, </span>
<span id="cb2-235"><a href="#cb2-235"></a>    <span class="dt">datetime =</span> <span class="st">&quot;datetime&quot;</span>, </span>
<span id="cb2-236"><a href="#cb2-236"></a>    <span class="dt">taxon_id =</span> <span class="st">&quot;taxon_id&quot;</span>, </span>
<span id="cb2-237"><a href="#cb2-237"></a>    <span class="dt">variable_name =</span> <span class="st">&quot;variable_name&quot;</span>,</span>
<span id="cb2-238"><a href="#cb2-238"></a>    <span class="dt">value =</span> <span class="st">&quot;value&quot;</span>,</span>
<span id="cb2-239"><a href="#cb2-239"></a>    <span class="dt">unit =</span> <span class="st">&quot;unit&quot;</span>)</span>
<span id="cb2-240"><a href="#cb2-240"></a>  </span>
<span id="cb2-241"><a href="#cb2-241"></a>  location &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_location</span>(</span>
<span id="cb2-242"><a href="#cb2-242"></a>    <span class="dt">L0_flat =</span> flat, </span>
<span id="cb2-243"><a href="#cb2-243"></a>    <span class="dt">location_id =</span> <span class="st">&quot;location_id&quot;</span>, </span>
<span id="cb2-244"><a href="#cb2-244"></a>    <span class="dt">location_name =</span> <span class="kw">c</span>(<span class="st">&quot;block&quot;</span>, <span class="st">&quot;plot&quot;</span>), </span>
<span id="cb2-245"><a href="#cb2-245"></a>    <span class="dt">latitude =</span> <span class="st">&quot;latitude&quot;</span>, </span>
<span id="cb2-246"><a href="#cb2-246"></a>    <span class="dt">longitude =</span> <span class="st">&quot;longitude&quot;</span>, </span>
<span id="cb2-247"><a href="#cb2-247"></a>    <span class="dt">elevation =</span> <span class="st">&quot;elevation&quot;</span>)</span>
<span id="cb2-248"><a href="#cb2-248"></a>  </span>
<span id="cb2-249"><a href="#cb2-249"></a>  taxon &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_taxon</span>(</span>
<span id="cb2-250"><a href="#cb2-250"></a>    <span class="dt">L0_flat =</span> flat, </span>
<span id="cb2-251"><a href="#cb2-251"></a>    <span class="dt">taxon_id =</span> <span class="st">&quot;taxon_id&quot;</span>, </span>
<span id="cb2-252"><a href="#cb2-252"></a>    <span class="dt">taxon_rank =</span> <span class="st">&quot;taxon_rank&quot;</span>, </span>
<span id="cb2-253"><a href="#cb2-253"></a>    <span class="dt">taxon_name =</span> <span class="st">&quot;taxon_name&quot;</span>, </span>
<span id="cb2-254"><a href="#cb2-254"></a>    <span class="dt">authority_system =</span> <span class="st">&quot;authority_system&quot;</span>, </span>
<span id="cb2-255"><a href="#cb2-255"></a>    <span class="dt">authority_taxon_id =</span> <span class="st">&quot;authority_taxon_id&quot;</span>)</span>
<span id="cb2-256"><a href="#cb2-256"></a>  </span>
<span id="cb2-257"><a href="#cb2-257"></a>  dataset_summary &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_dataset_summary</span>(</span>
<span id="cb2-258"><a href="#cb2-258"></a>    <span class="dt">L0_flat =</span> flat, </span>
<span id="cb2-259"><a href="#cb2-259"></a>    <span class="dt">package_id =</span> <span class="st">&quot;package_id&quot;</span>, </span>
<span id="cb2-260"><a href="#cb2-260"></a>    <span class="dt">original_package_id =</span> <span class="st">&quot;original_package_id&quot;</span>, </span>
<span id="cb2-261"><a href="#cb2-261"></a>    <span class="dt">length_of_survey_years =</span> <span class="st">&quot;length_of_survey_years&quot;</span>,</span>
<span id="cb2-262"><a href="#cb2-262"></a>    <span class="dt">number_of_years_sampled =</span> <span class="st">&quot;number_of_years_sampled&quot;</span>, </span>
<span id="cb2-263"><a href="#cb2-263"></a>    <span class="dt">std_dev_interval_betw_years =</span> <span class="st">&quot;std_dev_interval_betw_years&quot;</span>, </span>
<span id="cb2-264"><a href="#cb2-264"></a>    <span class="dt">max_num_taxa =</span> <span class="st">&quot;max_num_taxa&quot;</span>, </span>
<span id="cb2-265"><a href="#cb2-265"></a>    <span class="dt">geo_extent_bounding_box_m2 =</span> <span class="st">&quot;geo_extent_bounding_box_m2&quot;</span>)</span>
<span id="cb2-266"><a href="#cb2-266"></a>  </span>
<span id="cb2-267"><a href="#cb2-267"></a>  <span class="co"># Create the ancillary ecocomDP tables. These are optional, but should be </span></span>
<span id="cb2-268"><a href="#cb2-268"></a>  <span class="co"># included if possible.</span></span>
<span id="cb2-269"><a href="#cb2-269"></a>  </span>
<span id="cb2-270"><a href="#cb2-270"></a>  observation_ancillary &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_observation_ancillary</span>(</span>
<span id="cb2-271"><a href="#cb2-271"></a>    <span class="dt">L0_flat =</span> flat,</span>
<span id="cb2-272"><a href="#cb2-272"></a>    <span class="dt">observation_id =</span> <span class="st">&quot;observation_id&quot;</span>, </span>
<span id="cb2-273"><a href="#cb2-273"></a>    <span class="dt">variable_name =</span> <span class="kw">c</span>(<span class="st">&quot;trap.type&quot;</span>, <span class="st">&quot;trap.num&quot;</span>, <span class="st">&quot;moose.cage&quot;</span>))</span>
<span id="cb2-274"><a href="#cb2-274"></a>  </span>
<span id="cb2-275"><a href="#cb2-275"></a>  location_ancillary &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_location_ancillary</span>(</span>
<span id="cb2-276"><a href="#cb2-276"></a>    <span class="dt">L0_flat =</span> flat,</span>
<span id="cb2-277"><a href="#cb2-277"></a>    <span class="dt">location_id =</span> <span class="st">&quot;location_id&quot;</span>,</span>
<span id="cb2-278"><a href="#cb2-278"></a>    <span class="dt">variable_name =</span> <span class="st">&quot;treatment&quot;</span>)</span>
<span id="cb2-279"><a href="#cb2-279"></a>  </span>
<span id="cb2-280"><a href="#cb2-280"></a>  taxon_ancillary &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_taxon_ancillary</span>(</span>
<span id="cb2-281"><a href="#cb2-281"></a>    <span class="dt">L0_flat =</span> flat,</span>
<span id="cb2-282"><a href="#cb2-282"></a>    <span class="dt">taxon_id =</span> <span class="st">&quot;taxon_id&quot;</span>,</span>
<span id="cb2-283"><a href="#cb2-283"></a>    <span class="dt">variable_name =</span> <span class="kw">c</span>(</span>
<span id="cb2-284"><a href="#cb2-284"></a>      <span class="st">&quot;subfamily&quot;</span>, <span class="st">&quot;hl&quot;</span>, <span class="st">&quot;rel&quot;</span>, <span class="st">&quot;rll&quot;</span>, <span class="st">&quot;colony.size&quot;</span>, </span>
<span id="cb2-285"><a href="#cb2-285"></a>      <span class="st">&quot;feeding.preference&quot;</span>, <span class="st">&quot;nest.substrate&quot;</span>, <span class="st">&quot;primary.habitat&quot;</span>, </span>
<span id="cb2-286"><a href="#cb2-286"></a>      <span class="st">&quot;secondary.habitat&quot;</span>, <span class="st">&quot;seed.disperser&quot;</span>, <span class="st">&quot;slavemaker.sp&quot;</span>, </span>
<span id="cb2-287"><a href="#cb2-287"></a>      <span class="st">&quot;behavior&quot;</span>, <span class="st">&quot;biogeographic.affinity&quot;</span>, <span class="st">&quot;source&quot;</span>),</span>
<span id="cb2-288"><a href="#cb2-288"></a>    <span class="dt">unit =</span> <span class="kw">c</span>(<span class="st">&quot;unit_hl&quot;</span>, <span class="st">&quot;unit_rel&quot;</span>, <span class="st">&quot;unit_rll&quot;</span>))</span>
<span id="cb2-289"><a href="#cb2-289"></a>  </span>
<span id="cb2-290"><a href="#cb2-290"></a>  <span class="co"># Create the variable_mapping table. This is optional but highly recommended </span></span>
<span id="cb2-291"><a href="#cb2-291"></a>  <span class="co"># as it provides unambiguous definitions to variables and facilitates </span></span>
<span id="cb2-292"><a href="#cb2-292"></a>  <span class="co"># integration with other ecocomDP datasets.</span></span>
<span id="cb2-293"><a href="#cb2-293"></a>  </span>
<span id="cb2-294"><a href="#cb2-294"></a>  variable_mapping &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_variable_mapping</span>(</span>
<span id="cb2-295"><a href="#cb2-295"></a>    <span class="dt">observation =</span> observation,</span>
<span id="cb2-296"><a href="#cb2-296"></a>    <span class="dt">observation_ancillary =</span> observation_ancillary,</span>
<span id="cb2-297"><a href="#cb2-297"></a>    <span class="dt">location_ancillary =</span> location_ancillary, </span>
<span id="cb2-298"><a href="#cb2-298"></a>    <span class="dt">taxon_ancillary =</span> taxon_ancillary)</span>
<span id="cb2-299"><a href="#cb2-299"></a>  </span>
<span id="cb2-300"><a href="#cb2-300"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;abundance&#39;</span></span>
<span id="cb2-301"><a href="#cb2-301"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-302"><a href="#cb2-302"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://rs.tdwg.org/dwc/terms/individualCount&#39;</span></span>
<span id="cb2-303"><a href="#cb2-303"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;individualCount&#39;</span></span>
<span id="cb2-304"><a href="#cb2-304"></a>  </span>
<span id="cb2-305"><a href="#cb2-305"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;treatment&#39;</span></span>
<span id="cb2-306"><a href="#cb2-306"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;The Ecosystem Ontology&#39;</span></span>
<span id="cb2-307"><a href="#cb2-307"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://purl.dataone.org/odo/ECSO_00000506&#39;</span></span>
<span id="cb2-308"><a href="#cb2-308"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;Manipulative experiment&#39;</span></span>
<span id="cb2-309"><a href="#cb2-309"></a>  </span>
<span id="cb2-310"><a href="#cb2-310"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;trap.type&#39;</span></span>
<span id="cb2-311"><a href="#cb2-311"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;The Ecosystem Ontology&#39;</span></span>
<span id="cb2-312"><a href="#cb2-312"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://purl.dataone.org/odo/ECSO_00001591&#39;</span></span>
<span id="cb2-313"><a href="#cb2-313"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;type of trap&#39;</span></span>
<span id="cb2-314"><a href="#cb2-314"></a>  </span>
<span id="cb2-315"><a href="#cb2-315"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;hl&#39;</span></span>
<span id="cb2-316"><a href="#cb2-316"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-317"><a href="#cb2-317"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://rs.tdwg.org/dwc/terms/measurementType&#39;</span></span>
<span id="cb2-318"><a href="#cb2-318"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;measurementType&#39;</span></span>
<span id="cb2-319"><a href="#cb2-319"></a>  </span>
<span id="cb2-320"><a href="#cb2-320"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;rel&#39;</span></span>
<span id="cb2-321"><a href="#cb2-321"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-322"><a href="#cb2-322"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://rs.tdwg.org/dwc/terms/measurementType&#39;</span></span>
<span id="cb2-323"><a href="#cb2-323"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;measurementType&#39;</span></span>
<span id="cb2-324"><a href="#cb2-324"></a>  </span>
<span id="cb2-325"><a href="#cb2-325"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;rll&#39;</span></span>
<span id="cb2-326"><a href="#cb2-326"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-327"><a href="#cb2-327"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://rs.tdwg.org/dwc/terms/measurementType&#39;</span></span>
<span id="cb2-328"><a href="#cb2-328"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;measurementType&#39;</span></span>
<span id="cb2-329"><a href="#cb2-329"></a>  </span>
<span id="cb2-330"><a href="#cb2-330"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;colony.size&#39;</span></span>
<span id="cb2-331"><a href="#cb2-331"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;The Ecosystem Ontology&#39;</span></span>
<span id="cb2-332"><a href="#cb2-332"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://purl.dataone.org/odo/ECSO_00000311&#39;</span></span>
<span id="cb2-333"><a href="#cb2-333"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;Population&#39;</span></span>
<span id="cb2-334"><a href="#cb2-334"></a>  </span>
<span id="cb2-335"><a href="#cb2-335"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;feeding.preference&#39;</span></span>
<span id="cb2-336"><a href="#cb2-336"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-337"><a href="#cb2-337"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://rs.tdwg.org/dwc/terms/behavior&#39;</span></span>
<span id="cb2-338"><a href="#cb2-338"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;behavior&#39;</span></span>
<span id="cb2-339"><a href="#cb2-339"></a>  </span>
<span id="cb2-340"><a href="#cb2-340"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;primary.habitat&#39;</span></span>
<span id="cb2-341"><a href="#cb2-341"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;The Ecosystem Ontology&#39;</span></span>
<span id="cb2-342"><a href="#cb2-342"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://purl.dataone.org/odo/ECSO_00002736&#39;</span></span>
<span id="cb2-343"><a href="#cb2-343"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;type of habitat&#39;</span></span>
<span id="cb2-344"><a href="#cb2-344"></a>  </span>
<span id="cb2-345"><a href="#cb2-345"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;secondary.habitat&#39;</span></span>
<span id="cb2-346"><a href="#cb2-346"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;The Ecosystem Ontology&#39;</span></span>
<span id="cb2-347"><a href="#cb2-347"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://purl.dataone.org/odo/ECSO_00002736&#39;</span></span>
<span id="cb2-348"><a href="#cb2-348"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;type of habitat&#39;</span></span>
<span id="cb2-349"><a href="#cb2-349"></a>  </span>
<span id="cb2-350"><a href="#cb2-350"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;seed.disperser&#39;</span></span>
<span id="cb2-351"><a href="#cb2-351"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-352"><a href="#cb2-352"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://rs.tdwg.org/dwc/terms/behavior&#39;</span></span>
<span id="cb2-353"><a href="#cb2-353"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;behavior&#39;</span></span>
<span id="cb2-354"><a href="#cb2-354"></a>  </span>
<span id="cb2-355"><a href="#cb2-355"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;slavemaker.sp&#39;</span></span>
<span id="cb2-356"><a href="#cb2-356"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-357"><a href="#cb2-357"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://rs.tdwg.org/dwc/terms/behavior&#39;</span></span>
<span id="cb2-358"><a href="#cb2-358"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;behavior&#39;</span></span>
<span id="cb2-359"><a href="#cb2-359"></a>  </span>
<span id="cb2-360"><a href="#cb2-360"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;behavior&#39;</span></span>
<span id="cb2-361"><a href="#cb2-361"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-362"><a href="#cb2-362"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://rs.tdwg.org/dwc/terms/behavior&#39;</span></span>
<span id="cb2-363"><a href="#cb2-363"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;behavior&#39;</span></span>
<span id="cb2-364"><a href="#cb2-364"></a>  </span>
<span id="cb2-365"><a href="#cb2-365"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;biogeographic.affinity&#39;</span></span>
<span id="cb2-366"><a href="#cb2-366"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;The Ecosystem Ontology&#39;</span></span>
<span id="cb2-367"><a href="#cb2-367"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://purl.dataone.org/odo/ECSO_00002736&#39;</span></span>
<span id="cb2-368"><a href="#cb2-368"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;type of habitat&#39;</span></span>
<span id="cb2-369"><a href="#cb2-369"></a>  </span>
<span id="cb2-370"><a href="#cb2-370"></a>  i &lt;-<span class="st"> </span>variable_mapping<span class="op">$</span>variable_name <span class="op">==</span><span class="st"> &#39;source&#39;</span></span>
<span id="cb2-371"><a href="#cb2-371"></a>  variable_mapping<span class="op">$</span>mapped_system[i] &lt;-<span class="st"> &#39;Darwin Core&#39;</span></span>
<span id="cb2-372"><a href="#cb2-372"></a>  variable_mapping<span class="op">$</span>mapped_id[i] &lt;-<span class="st"> &#39;http://purl.org/dc/terms/references&#39;</span></span>
<span id="cb2-373"><a href="#cb2-373"></a>  variable_mapping<span class="op">$</span>mapped_label[i] &lt;-<span class="st"> &#39;references&#39;</span></span>
<span id="cb2-374"><a href="#cb2-374"></a>  </span>
<span id="cb2-375"><a href="#cb2-375"></a>  <span class="co"># Write tables to file</span></span>
<span id="cb2-376"><a href="#cb2-376"></a>  </span>
<span id="cb2-377"><a href="#cb2-377"></a>  ecocomDP<span class="op">::</span><span class="kw">write_tables</span>(</span>
<span id="cb2-378"><a href="#cb2-378"></a>    <span class="dt">path =</span> path, </span>
<span id="cb2-379"><a href="#cb2-379"></a>    <span class="dt">observation =</span> observation, </span>
<span id="cb2-380"><a href="#cb2-380"></a>    <span class="dt">location =</span> location,</span>
<span id="cb2-381"><a href="#cb2-381"></a>    <span class="dt">taxon =</span> taxon,</span>
<span id="cb2-382"><a href="#cb2-382"></a>    <span class="dt">dataset_summary =</span> dataset_summary, </span>
<span id="cb2-383"><a href="#cb2-383"></a>    <span class="dt">observation_ancillary =</span> observation_ancillary,</span>
<span id="cb2-384"><a href="#cb2-384"></a>    <span class="dt">location_ancillary =</span> location_ancillary, </span>
<span id="cb2-385"><a href="#cb2-385"></a>    <span class="dt">taxon_ancillary =</span> taxon_ancillary, </span>
<span id="cb2-386"><a href="#cb2-386"></a>    <span class="dt">variable_mapping =</span> variable_mapping)</span>
<span id="cb2-387"><a href="#cb2-387"></a>  </span>
<span id="cb2-388"><a href="#cb2-388"></a>  <span class="co"># Validate tables -----------------------------------------------------------</span></span>
<span id="cb2-389"><a href="#cb2-389"></a>  </span>
<span id="cb2-390"><a href="#cb2-390"></a>  <span class="co"># Validation checks ensure the derived set of tables comply with the ecocomDP</span></span>
<span id="cb2-391"><a href="#cb2-391"></a>  <span class="co"># model. Any issues at this point </span></span>
<span id="cb2-392"><a href="#cb2-392"></a>  <span class="co"># should be addressed in the lines of code above, the tables rewritten, and </span></span>
<span id="cb2-393"><a href="#cb2-393"></a>  <span class="co"># another round of validation, to be certain the fix worked.</span></span>
<span id="cb2-394"><a href="#cb2-394"></a>  </span>
<span id="cb2-395"><a href="#cb2-395"></a>  issues &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">validate_data</span>(<span class="dt">path =</span> path)</span>
<span id="cb2-396"><a href="#cb2-396"></a>  </span>
<span id="cb2-397"><a href="#cb2-397"></a>  <span class="co"># Create metadata -----------------------------------------------------------</span></span>
<span id="cb2-398"><a href="#cb2-398"></a>  </span>
<span id="cb2-399"><a href="#cb2-399"></a>  <span class="co"># Before publishing the derived ecocomDP dataset, we need to describe it. The </span></span>
<span id="cb2-400"><a href="#cb2-400"></a>  <span class="co"># create_eml() function does this all for us. It knows the structure of the </span></span>
<span id="cb2-401"><a href="#cb2-401"></a>  <span class="co"># ecocomDP model and applies standardized table descriptions and mixes in </span></span>
<span id="cb2-402"><a href="#cb2-402"></a>  <span class="co"># important elements of the source dataset metadata for purposes of </span></span>
<span id="cb2-403"><a href="#cb2-403"></a>  <span class="co"># communication and provenance tracking.</span></span>
<span id="cb2-404"><a href="#cb2-404"></a>  </span>
<span id="cb2-405"><a href="#cb2-405"></a>  <span class="co"># Convert &quot;dataset level keywords&quot; listed in the source to &quot;dataset level </span></span>
<span id="cb2-406"><a href="#cb2-406"></a>  <span class="co"># annotations&quot; in the derived. The predicate &quot;is about&quot; is used, which </span></span>
<span id="cb2-407"><a href="#cb2-407"></a>  <span class="co"># results in an annotation that reads &quot;This dataset is about &#39;species </span></span>
<span id="cb2-408"><a href="#cb2-408"></a>  <span class="co"># abundance&#39;&quot;, &quot;This dataset is about &#39;Population&#39;, etc.</span></span>
<span id="cb2-409"><a href="#cb2-409"></a>  </span>
<span id="cb2-410"><a href="#cb2-410"></a>  dataset_annotations &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb2-411"><a href="#cb2-411"></a>    <span class="st">`</span><span class="dt">species abundance</span><span class="st">`</span> =<span class="st"> </span></span>
<span id="cb2-412"><a href="#cb2-412"></a><span class="st">      &quot;http://purl.dataone.org/odo/ECSO_00001688&quot;</span>,</span>
<span id="cb2-413"><a href="#cb2-413"></a>    <span class="dt">Population =</span> </span>
<span id="cb2-414"><a href="#cb2-414"></a>      <span class="st">&quot;http://purl.dataone.org/odo/ECSO_00000311&quot;</span>,</span>
<span id="cb2-415"><a href="#cb2-415"></a>    <span class="st">`</span><span class="dt">level of ecological disturbance</span><span class="st">`</span> =<span class="st"> </span></span>
<span id="cb2-416"><a href="#cb2-416"></a><span class="st">      &quot;http://purl.dataone.org/odo/ECSO_00002588&quot;</span>,</span>
<span id="cb2-417"><a href="#cb2-417"></a>    <span class="st">`</span><span class="dt">type of ecological disturbance</span><span class="st">`</span> =<span class="st"> </span></span>
<span id="cb2-418"><a href="#cb2-418"></a><span class="st">      &quot;http://purl.dataone.org/odo/ECSO_00002589&quot;</span>)</span>
<span id="cb2-419"><a href="#cb2-419"></a>  </span>
<span id="cb2-420"><a href="#cb2-420"></a>  <span class="co"># Add contact information for the author of this script and dataset</span></span>
<span id="cb2-421"><a href="#cb2-421"></a>  </span>
<span id="cb2-422"><a href="#cb2-422"></a>  additional_contact &lt;-<span class="st"> </span><span class="kw">data.frame</span>(</span>
<span id="cb2-423"><a href="#cb2-423"></a>    <span class="dt">givenName =</span> <span class="st">&#39;Colin&#39;</span>,</span>
<span id="cb2-424"><a href="#cb2-424"></a>    <span class="dt">surName =</span> <span class="st">&#39;Smith&#39;</span>,</span>
<span id="cb2-425"><a href="#cb2-425"></a>    <span class="dt">organizationName =</span> <span class="st">&#39;Environmental Data Initiative&#39;</span>,</span>
<span id="cb2-426"><a href="#cb2-426"></a>    <span class="dt">electronicMailAddress =</span> <span class="st">&#39;ecocomdp@gmail.com&#39;</span>,</span>
<span id="cb2-427"><a href="#cb2-427"></a>    <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</span>
<span id="cb2-428"><a href="#cb2-428"></a>  </span>
<span id="cb2-429"><a href="#cb2-429"></a>  <span class="co"># Create EML metadata</span></span>
<span id="cb2-430"><a href="#cb2-430"></a>  </span>
<span id="cb2-431"><a href="#cb2-431"></a>  eml &lt;-<span class="st"> </span>ecocomDP<span class="op">::</span><span class="kw">create_eml</span>(</span>
<span id="cb2-432"><a href="#cb2-432"></a>    <span class="dt">path =</span> path,</span>
<span id="cb2-433"><a href="#cb2-433"></a>    <span class="dt">source_id =</span> source_id,</span>
<span id="cb2-434"><a href="#cb2-434"></a>    <span class="dt">derived_id =</span> derived_id,</span>
<span id="cb2-435"><a href="#cb2-435"></a>    <span class="dt">is_about =</span> dataset_annotations,</span>
<span id="cb2-436"><a href="#cb2-436"></a>    <span class="dt">script =</span> <span class="st">&quot;create_ecocomDP.R&quot;</span>,</span>
<span id="cb2-437"><a href="#cb2-437"></a>    <span class="dt">script_description =</span> </span>
<span id="cb2-438"><a href="#cb2-438"></a>      <span class="st">&quot;A function for converting knb-lter-hrf.118 to ecocomDP&quot;</span>,</span>
<span id="cb2-439"><a href="#cb2-439"></a>    <span class="dt">contact =</span> additional_contact,</span>
<span id="cb2-440"><a href="#cb2-440"></a>    <span class="dt">user_id =</span> <span class="st">&#39;ecocomdp&#39;</span>,</span>
<span id="cb2-441"><a href="#cb2-441"></a>    <span class="dt">user_domain =</span> <span class="st">&#39;EDI&#39;</span>,</span>
<span id="cb2-442"><a href="#cb2-442"></a>    <span class="dt">basis_of_record =</span> <span class="st">&quot;HumanObservation&quot;</span>)</span>
<span id="cb2-443"><a href="#cb2-443"></a>  </span>
<span id="cb2-444"><a href="#cb2-444"></a>}</span></code></pre></div>
</div>
<div id="example-function-call" class="section level4">
<h4>Example function call:</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># Create directory for tables and metadata</span></span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a>mypath &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;/edi_193&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="kw">dir.create</span>(mypath)</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># Create ecocomDP dataset &quot;edi.193.4&quot; from source dataset &quot;knb-lter-hfr.118.32&quot;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="kw">create_ecocomDP</span>(</span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="dt">path =</span> mypath, </span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="dt">source_id =</span> <span class="st">&quot;knb-lter-hfr.118.32&quot;</span>, </span>
<span id="cb3-12"><a href="#cb3-12"></a>  <span class="dt">derived_id =</span> <span class="st">&quot;edi.193.4&quot;</span>)</span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co">#&gt; Retrieving EML for data package knb-lter-hfr.118.32</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co">#&gt;  [0%] Downloaded 0 bytes...</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">#&gt;  [0%] Downloaded 0 bytes...</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co">#&gt;</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">#&gt; Searching ITIS for &quot;Aphaenogaster picea&quot;</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co">#&gt; Searching ITIS for &quot;Camponotus novaeboracensis&quot;</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">#&gt; Searching ITIS for &quot;Aphaenogaster fulva&quot;</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">#&gt; Searching ITIS for &quot;Temnothorax longispinosus&quot;</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">#&gt; Searching ITIS for &quot;Stenemma impar&quot;</span></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="co">#&gt; Searching ITIS for &quot;Stenemma diecki&quot;</span></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="co">#&gt; Searching ITIS for &quot;Camponotus pennsylvanicus&quot;</span></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius americanus&quot;</span></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="co">#&gt; Searching ITIS for &quot;Myrmica punctiventris&quot;</span></span>
<span id="cb3-26"><a href="#cb3-26"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius nearcticus&quot;</span></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="co">#&gt; Searching ITIS for &quot;Formica subaenescens&quot;</span></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius umbratus&quot;</span></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="co">#&gt; Searching ITIS for &quot;Formica subsericea&quot;</span></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="co">#&gt; Searching ITIS for &quot;Formica aserva&quot;</span></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co">#&gt; Searching ITIS for &quot;Formica neogagates&quot;</span></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="co">#&gt; Searching ITIS for &quot;Camponotus nearcticus&quot;</span></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="co">#&gt; Searching ITIS for &quot;Ponera pennsylvanica&quot;</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="co">#&gt; Searching ITIS for &quot;Stenamma brevicorne&quot;</span></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius claviger&quot;</span></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="co">#&gt; Searching ITIS for &quot;Stenamma impar&quot;</span></span>
<span id="cb3-37"><a href="#cb3-37"></a><span class="co">#&gt; Searching ITIS for &quot;Temnothorax lognispinosus&quot;</span></span>
<span id="cb3-38"><a href="#cb3-38"></a><span class="co">#&gt; Searching ITIS for &quot;Stenamma diecki&quot;</span></span>
<span id="cb3-39"><a href="#cb3-39"></a><span class="co">#&gt; Searching ITIS for &quot;Camponotus herculeanus&quot;</span></span>
<span id="cb3-40"><a href="#cb3-40"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius speculiventris&quot;</span></span>
<span id="cb3-41"><a href="#cb3-41"></a><span class="co">#&gt; Searching ITIS for &quot;Stenamma schmitti&quot;</span></span>
<span id="cb3-42"><a href="#cb3-42"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius neoniger&quot;</span></span>
<span id="cb3-43"><a href="#cb3-43"></a><span class="co">#&gt; Searching ITIS for &quot;Camponotus pennsylvanica&quot;</span></span>
<span id="cb3-44"><a href="#cb3-44"></a><span class="co">#&gt; Searching ITIS for &quot;Tapinoma sessile&quot;</span></span>
<span id="cb3-45"><a href="#cb3-45"></a><span class="co">#&gt; Searching ITIS for &quot;Myrmica AF-smi&quot;</span></span>
<span id="cb3-46"><a href="#cb3-46"></a><span class="co">#&gt; Searching ITIS for &quot;Formica neorufibarbis&quot;</span></span>
<span id="cb3-47"><a href="#cb3-47"></a><span class="co">#&gt; Searching ITIS for &quot;Myrmica incompleta&quot;</span></span>
<span id="cb3-48"><a href="#cb3-48"></a><span class="co">#&gt; Searching ITIS for &quot;Formica argentea&quot;</span></span>
<span id="cb3-49"><a href="#cb3-49"></a><span class="co">#&gt; Searching ITIS for &quot;Myrmica AF-scu&quot;</span></span>
<span id="cb3-50"><a href="#cb3-50"></a><span class="co">#&gt; Searching ITIS for &quot;Formica dolosa&quot;</span></span>
<span id="cb3-51"><a href="#cb3-51"></a><span class="co">#&gt; Searching ITIS for &quot;Formica subintegra&quot;</span></span>
<span id="cb3-52"><a href="#cb3-52"></a><span class="co">#&gt; Searching ITIS for &quot;Formica incerta&quot;</span></span>
<span id="cb3-53"><a href="#cb3-53"></a><span class="co">#&gt; Searching ITIS for &quot;Myrmica nearctica&quot;</span></span>
<span id="cb3-54"><a href="#cb3-54"></a><span class="co">#&gt; Searching ITIS for &quot;Formica pergandei&quot;</span></span>
<span id="cb3-55"><a href="#cb3-55"></a><span class="co">#&gt; Searching ITIS for &quot;Formica lasioides&quot;</span></span>
<span id="cb3-56"><a href="#cb3-56"></a><span class="co">#&gt; Searching ITIS for &quot;Myrmica pinetorum&quot;</span></span>
<span id="cb3-57"><a href="#cb3-57"></a><span class="co">#&gt; Searching ITIS for &quot;Leptothorax canadensis&quot;</span></span>
<span id="cb3-58"><a href="#cb3-58"></a><span class="co">#&gt; Searching ITIS for &quot;Myrmica detritinodis&quot;</span></span>
<span id="cb3-59"><a href="#cb3-59"></a><span class="co">#&gt; Searching ITIS for &quot;Myrmecina americana&quot;</span></span>
<span id="cb3-60"><a href="#cb3-60"></a><span class="co">#&gt; Searching ITIS for &quot;Crematogaster lineolata&quot;</span></span>
<span id="cb3-61"><a href="#cb3-61"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius interjectus&quot;</span></span>
<span id="cb3-62"><a href="#cb3-62"></a><span class="co">#&gt; Searching ITIS for &quot;Camponotus chromaiodes&quot;</span></span>
<span id="cb3-63"><a href="#cb3-63"></a><span class="co">#&gt; Searching ITIS for &quot;Formica pallidefulva&quot;</span></span>
<span id="cb3-64"><a href="#cb3-64"></a><span class="co">#&gt; Searching ITIS for &quot;Temnothorax ambiguus&quot;</span></span>
<span id="cb3-65"><a href="#cb3-65"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius subglaber&quot;</span></span>
<span id="cb3-66"><a href="#cb3-66"></a><span class="co">#&gt; Searching ITIS for &quot;Formica rubicunda&quot;</span></span>
<span id="cb3-67"><a href="#cb3-67"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius brevicornis&quot;</span></span>
<span id="cb3-68"><a href="#cb3-68"></a><span class="co">#&gt; Searching ITIS for &quot;Lasius aphidicolus&quot;</span></span>
<span id="cb3-69"><a href="#cb3-69"></a><span class="co">#&gt; Searching ITIS for &quot;Formica integra&quot;</span></span>
<span id="cb3-70"><a href="#cb3-70"></a><span class="co">#&gt;</span></span>
<span id="cb3-71"><a href="#cb3-71"></a><span class="co">#&gt; Writing tables to file:</span></span>
<span id="cb3-72"><a href="#cb3-72"></a><span class="co">#&gt;   observation</span></span>
<span id="cb3-73"><a href="#cb3-73"></a><span class="co">#&gt;   location</span></span>
<span id="cb3-74"><a href="#cb3-74"></a><span class="co">#&gt;   taxon</span></span>
<span id="cb3-75"><a href="#cb3-75"></a><span class="co">#&gt;   dataset_summary</span></span>
<span id="cb3-76"><a href="#cb3-76"></a><span class="co">#&gt;   observation_ancillary</span></span>
<span id="cb3-77"><a href="#cb3-77"></a><span class="co">#&gt;   location_ancillary</span></span>
<span id="cb3-78"><a href="#cb3-78"></a><span class="co">#&gt;   taxon_ancillary</span></span>
<span id="cb3-79"><a href="#cb3-79"></a><span class="co">#&gt;   variable_mapping</span></span>
<span id="cb3-80"><a href="#cb3-80"></a><span class="co">#&gt;</span></span>
<span id="cb3-81"><a href="#cb3-81"></a><span class="co">#&gt; Validating edi_193:</span></span>
<span id="cb3-82"><a href="#cb3-82"></a><span class="co">#&gt;   Required tables</span></span>
<span id="cb3-83"><a href="#cb3-83"></a><span class="co">#&gt;   Column names</span></span>
<span id="cb3-84"><a href="#cb3-84"></a><span class="co">#&gt;   Required columns</span></span>
<span id="cb3-85"><a href="#cb3-85"></a><span class="co">#&gt;   Column classes</span></span>
<span id="cb3-86"><a href="#cb3-86"></a><span class="co">#&gt;   Datetime formats</span></span>
<span id="cb3-87"><a href="#cb3-87"></a><span class="co">#&gt;   Primary keys</span></span>
<span id="cb3-88"><a href="#cb3-88"></a><span class="co">#&gt;   Composite keys</span></span>
<span id="cb3-89"><a href="#cb3-89"></a><span class="co">#&gt;   Referential integrity</span></span>
<span id="cb3-90"><a href="#cb3-90"></a><span class="co">#&gt;   Latitude and longitude format</span></span>
<span id="cb3-91"><a href="#cb3-91"></a><span class="co">#&gt;   Latitude and longitude range</span></span>
<span id="cb3-92"><a href="#cb3-92"></a><span class="co">#&gt;   Elevation</span></span>
<span id="cb3-93"><a href="#cb3-93"></a><span class="co">#&gt;   variable_mapping</span></span>
<span id="cb3-94"><a href="#cb3-94"></a><span class="co">#&gt;</span></span>
<span id="cb3-95"><a href="#cb3-95"></a><span class="co">#&gt; Creating EML for derived data package (edi.193.4)</span></span>
<span id="cb3-96"><a href="#cb3-96"></a><span class="co">#&gt; Reading EML of L0 data package knb-lter-hfr.118.32</span></span>
<span id="cb3-97"><a href="#cb3-97"></a><span class="co">#&gt; Creating EML of L1 data package edi.193.4</span></span>
<span id="cb3-98"><a href="#cb3-98"></a><span class="co">#&gt; Updating:</span></span>
<span id="cb3-99"><a href="#cb3-99"></a><span class="co">#&gt; &lt;eml&gt;</span></span>
<span id="cb3-100"><a href="#cb3-100"></a><span class="co">#&gt;   &lt;dataset&gt;</span></span>
<span id="cb3-101"><a href="#cb3-101"></a><span class="co">#&gt;     &lt;alternateIdentifier&gt;</span></span>
<span id="cb3-102"><a href="#cb3-102"></a><span class="co">#&gt;     &lt;title&gt;</span></span>
<span id="cb3-103"><a href="#cb3-103"></a><span class="co">#&gt;     &lt;pubDate&gt;</span></span>
<span id="cb3-104"><a href="#cb3-104"></a><span class="co">#&gt;     &lt;keywordSet&gt;</span></span>
<span id="cb3-105"><a href="#cb3-105"></a><span class="co">#&gt;     &lt;contact&gt;</span></span>
<span id="cb3-106"><a href="#cb3-106"></a><span class="co">#&gt;     &lt;methods&gt;</span></span>
<span id="cb3-107"><a href="#cb3-107"></a><span class="co">#&gt;     &lt;dataTable&gt;</span></span>
<span id="cb3-108"><a href="#cb3-108"></a><span class="co">#&gt;     &lt;otherEntity&gt;</span></span>
<span id="cb3-109"><a href="#cb3-109"></a><span class="co">#&gt;     &lt;annotations&gt;</span></span>
<span id="cb3-110"><a href="#cb3-110"></a><span class="co">#&gt; &lt;/eml&gt;</span></span>
<span id="cb3-111"><a href="#cb3-111"></a><span class="co">#&gt; Writing EML</span></span>
<span id="cb3-112"><a href="#cb3-112"></a><span class="co">#&gt; Validating EML</span></span>
<span id="cb3-113"><a href="#cb3-113"></a><span class="co">#&gt;   Validation passed :)</span></span>
<span id="cb3-114"><a href="#cb3-114"></a><span class="co">#&gt; Done.</span></span>
<span id="cb3-115"><a href="#cb3-115"></a></span>
<span id="cb3-116"><a href="#cb3-116"></a><span class="co"># The working directory contains a valid set of ecocomDP tables and metadata, </span></span>
<span id="cb3-117"><a href="#cb3-117"></a><span class="co"># which is ready for upload to EDI (or any other EML based repository)</span></span>
<span id="cb3-118"><a href="#cb3-118"></a><span class="kw">dir</span>(mypath)</span>
<span id="cb3-119"><a href="#cb3-119"></a><span class="co">#&gt;  [1] &quot;create_ecocomDP.R&quot;        </span></span>
<span id="cb3-120"><a href="#cb3-120"></a><span class="co">#&gt;  [2] &quot;dataset_summary.csv&quot;      </span></span>
<span id="cb3-121"><a href="#cb3-121"></a><span class="co">#&gt;  [3] &quot;edi.193.4.xml&quot;            </span></span>
<span id="cb3-122"><a href="#cb3-122"></a><span class="co">#&gt;  [4] &quot;location.csv&quot;             </span></span>
<span id="cb3-123"><a href="#cb3-123"></a><span class="co">#&gt;  [5] &quot;location_ancillary.csv&quot;   </span></span>
<span id="cb3-124"><a href="#cb3-124"></a><span class="co">#&gt;  [6] &quot;observation.csv&quot;          </span></span>
<span id="cb3-125"><a href="#cb3-125"></a><span class="co">#&gt;  [7] &quot;observation_ancillary.csv&quot;</span></span>
<span id="cb3-126"><a href="#cb3-126"></a><span class="co">#&gt;  [8] &quot;taxon.csv&quot;                </span></span>
<span id="cb3-127"><a href="#cb3-127"></a><span class="co">#&gt;  [9] &quot;taxon_ancillary.csv&quot;      </span></span>
<span id="cb3-128"><a href="#cb3-128"></a><span class="co">#&gt; [10] &quot;variable_mapping.csv&quot;</span></span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
